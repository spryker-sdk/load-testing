/*
 * Copyright 2011-2019 GatlingCorp (https://gatling.io)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package spryker

import io.gatling.core.Predef._
import io.gatling.http.Predef._
import scala.concurrent.duration._
import scala.util.Random
import spryker.YvesProtocol._
import spryker.Scenario._

trait PlaceOrderWithOffersBase {

    lazy val scenarioName = "Place Order page"

    val httpProtocol = YvesProtocol.httpProtocol
    val feeder = csv("tests/_data/merchant_product_offer.csv").random;

    val request = http(scenarioName)
        .post("/place-order-debug")
        .formParam("_payload", """{"is_guest_express_checkout":null,"consumer_score":null,"is_address_valid":null,"price_mode":"GROSS_MODE","is_locked":null,"uuid":null,"customer_reference":null,"cart_note":null,"id_quote":null,"company_user_id":null,"name":"Guest shopping cart","billing_same_as_shipping":true,"order_reference":null,"is_address_saving_skipped":null,"used_not_applied_voucher_codes":[],"not_applicable_gift_card_codes":[],"voucher_code":null,"merchant_reference":null,"is_default":null,"key":null,"id_offer":null,"offer_fee":null,"checkout_confirmed":true,"id_customer":null,"order_custom_reference":null,"quote_request_version_reference":null,"quote_request_reference":null,"accept_terms_and_conditions":false,"store":{"available_locale_iso_codes":{"en":"en_US","de":"de_DE"},"queue_pools":{"synchronizationPool":["AT-connection","DE-connection"]},"stores_with_shared_persistence":["AT"],"id_store":null,"name":"DE","default_currency_iso_code":"EUR","available_currency_iso_codes":["EUR","CHF"],"selected_currency_iso_code":"EUR","timezone":"Europe/Berlin","countries":["DE","AT","NO","CH","ES","GB"]},"totals":{"subtotal":8800,"expense_total":490,"discount_total":0,"grand_total":9290,"net_total":7807,"canceled_total":null,"hash":"137ea7d0d28a4d3e9f79abee6ec1681a514b752a440a8d9157a4ab6c0b276b03","refund_total":9290,"price_to_pay":9290,"remuneration_total":null,"shipment_total":490,"tax_total":{"tax_rate":null,"amount":1483}},"currency":{"code":"EUR","symbol":"€","id_currency":null,"name":"Euro","is_default":true,"fraction_digits":2},"customer":{"id_customer":null,"first_name":"Spryker","last_name":"Guest","email":"spryker.guest@test.com","customer_reference":null,"availability_notification_subscription_skus":[],"is_on_behalf":null,"is_guest":true,"default_billing_address":null,"default_shipping_address":null,"company_user_invitation_hash":null,"company":null,"gender":null,"date_of_birth":null,"salutation":"Mr","password":null,"new_password":null,"created_at":null,"updated_at":null,"restore_password_key":null,"restore_password_link":null,"restore_password_date":null,"registration_key":null,"confirmation_link":null,"registered":null,"message":null,"send_password_token":null,"anonymized_at":null,"fk_user":null,"username":null,"phone":null,"is_dirty":null,"company_user_transfer":null,"addresses":null,"permissions":null,"locale":null,"customer_product_list_collection":null,"billing_address":[],"shipping_address":[]},"quote_permission_group":null,"billing_address":{"first_name":"Spryker","last_name":"Guest","address1":"Seeburger Str.","address2":"270","address3":"Block B","company":"Ottom ltd","city":"Berlin","zip_code":"10115","state":null,"iso2_code":"DE","id_customer_address":null,"uuid":null,"is_default_billing":true,"is_default_shipping":true,"customer_id":null,"fk_customer":null,"email":null,"salutation":"Mr","phone":"","comment":null,"is_deleted":null,"fk_country":null,"fk_region":null,"anonymized_at":null,"is_address_saving_skipped":null,"id_sales_order_address":null,"id_company_unit_address":null,"fk_misc_country":null,"key":null,"region":null,"middle_name":null,"cell_phone":null,"po_box":null,"description":null,"country":null,"method":null},"shipping_address":{"first_name":"Andrew","last_name":"Wedner","address1":"Seeburger Str.","address2":"270","address3":"Block B","company":"Ottom ltd","city":"Berlin","zip_code":"10115","state":null,"iso2_code":"DE","id_customer_address":null,"uuid":null,"is_default_billing":null,"is_default_shipping":true,"customer_id":null,"fk_customer":null,"email":null,"salutation":"Mr","phone":"","comment":null,"is_deleted":null,"fk_country":null,"fk_region":null,"anonymized_at":null,"is_address_saving_skipped":null,"id_sales_order_address":null,"id_company_unit_address":null,"fk_misc_country":null,"key":null,"region":null,"middle_name":null,"cell_phone":null,"po_box":null,"description":null,"country":null,"method":null},"shipment":{"id_sales_shipment":null,"requested_delivery_date":"","shipment_selection":1,"merchant_reference":null,"shipping_address":{"first_name":"Spryker","last_name":"Guest","address1":"Seeburger Str.","address2":"270","address3":"Block B","company":"Ottom ltd","city":"Berlin","zip_code":"10115","state":null,"iso2_code":"DE","id_customer_address":null,"uuid":null,"is_default_billing":null,"is_default_shipping":true,"customer_id":null,"fk_customer":null,"email":null,"salutation":"Mr","phone":"04908892450","comment":null,"is_deleted":null,"fk_country":null,"fk_region":null,"anonymized_at":null,"is_address_saving_skipped":null,"id_sales_order_address":null,"id_company_unit_address":null,"fk_misc_country":null,"key":null,"region":null,"middle_name":null,"cell_phone":null,"po_box":null,"description":null,"country":null,"method":null},"method":{"id_shipment_method":1,"store_currency_price":490,"name":"Standard","currency_iso_code":"EUR","carrier_name":"Spryker Dummy Shipment","fk_sales_expense":null,"fk_shipment_carrier":1,"fk_tax_set":4,"availability_plugin":null,"price_plugin":null,"delivery_time_plugin":null,"tax_rate":null,"is_active":true,"delivery_time":null,"shipment_method_key":"spryker_dummy_shipment-standard","id":null,"source_price":null,"store_relation":{"id_entity":1,"id_stores":[1,2],"stores":[{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]},{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":2,"name":"AT","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}]},"prices":[{"fk_store":1,"net_amount":450,"gross_amount":560,"id_entity":6,"fk_currency":61,"price_data":null,"price_data_checksum":null,"currency":{"code":"CHF","symbol":"CHF","id_currency":61,"name":"Swiss Franc","is_default":null,"fraction_digits":null},"store":{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}},{"fk_store":1,"net_amount":390,"gross_amount":490,"id_entity":1,"fk_currency":93,"price_data":null,"price_data_checksum":null,"currency":{"code":"EUR","symbol":"€","id_currency":93,"name":"Euro","is_default":null,"fraction_digits":null},"store":{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}}]},"carrier":null},"comment_thread":null,"payment":{"summary_include_path":null,"success_include_path":null,"payment_provider":"DummyPayment","payment_method":"invoice","payment_selection":"dummyPaymentInvoice","is_limited_amount":null,"available_amount":null,"amount":9290,"id_sales_payment":null,"payone":null,"payone_credit_card":{"reference":null,"cardtype":null,"cardholder":null,"cardexpiredate_month":null,"cardexpiredate_year":null,"pseudocardpan":null,"payone_client_api_config":"{\"aid\":\"\",\"encoding\":\"UTF-8\",\"hash\":\"aaf24ce3b15187b54365f020b18630ac\",\"mid\":\"\",\"mode\":\"test\",\"portalid\":\"\",\"request\":\"creditcardcheck\",\"responsetype\":\"JSON\",\"storecarddata\":\"yes\",\"utilEncodingService\":{}}","payone_client_lang_code":null},"payone_direct_debit":null,"payone_online_transfer":null,"payone_eps_online_transfer":null,"payone_giropay_online_transfer":null,"payone_instant_online_transfer":{"onlinebanktransfertype":"PNT","bankcountry":"DE","bankaccount":null,"bankcode":null,"bankbranchcode":null,"bankcheckdigit":null,"bankgrouptype":null,"iban":null,"bic":null},"payone_ideal_online_transfer":null,"payone_postfinance_efinance_online_transfer":null,"payone_postfinance_card_online_transfer":null,"payone_przelewy24_online_transfer":null,"payone_bancontact_online_transfer":null,"payone_cash_on_delivery":null,"payone_e_wallet":null,"payone_pre_payment":null,"payone_invoice":null,"payone_security_invoice":null,"payone_paypal_express_checkout":null,"dummy_marketplace_payment_invoice":{"payment_method":null,"date_of_birth":null},"dummy_payment_credit_card":{"date_of_birth":null,"card_security_code":null,"card_expires_year":2020,"card_expires_month":"01","name_on_card":null,"card_number":null,"card_type":"Visa"},"dummy_payment_invoice":{"date_of_birth":"1989-03-09","card_security_code":null,"card_expires_year":null,"card_expires_month":null,"name_on_card":null,"card_number":null,"card_type":null},"dummy_payment":{"date_of_birth":"1989-03-09","card_security_code":null,"card_expires_year":null,"card_expires_month":null,"name_on_card":null,"card_number":null,"card_type":null},"gift_card":null,"nopayment":null},"order_source":null,"manual_order":null,"items":[{"sku":"${product_sku}","quantity":10,"unit_gross_price":880,"sum_gross_price":8800,"tax_rate":19,"unit_net_price":0,"sum_net_price":0,"unit_price":880,"sum_price":8800,"unit_tax_amount_full_aggregation":141,"sum_tax_amount_full_aggregation":1405,"refundable_amount":8800,"canceled_amount":0,"sum_subtotal_aggregation":8800,"unit_subtotal_aggregation":880,"unit_product_option_price_aggregation":0,"sum_product_option_price_aggregation":0,"unit_expense_price_aggregation":null,"sum_expense_price_aggregation":null,"unit_discount_amount_aggregation":0,"sum_discount_amount_aggregation":0,"unit_discount_amount_full_aggregation":0,"sum_discount_amount_full_aggregation":0,"unit_price_to_pay_aggregation":880,"sum_price_to_pay_aggregation":8800,"tax_rate_average_aggregation":19,"tax_amount_after_cancellation":null,"is_ordered":null,"unit_tax_amount":141,"sum_tax_amount":1405,"id":null,"group_key":"${product_sku}","group_key_prefix":null,"normalizable_fields":[],"cart_note":null,"id_sales_order_item":null,"id_product_abstract":null,"name":"Product #5f748ccc796910.61072866","abstract_sku":"4771219354","max_quantity":null,"id_discount_promotion":null,"merchant_reference":null,"forced_unit_gross_price":null,"product_offer_reference": ${product_offer_reference},"merchant_order_reference":null,"source_unit_gross_price":null,"source_unit_net_price":null,"offer_discount":null,"offer_fee":null,"saving_amount":null,"origin_unit_gross_price":880,"origin_unit_net_price":0,"process":null,"fk_sales_order":null,"uuid":null,"order_reference":null,"bundle_item_identifier":null,"related_bundle_item_identifier":null,"is_returnable":null,"concrete_attributes":[],"url":"${pdp_url}","merchant_sku":null,"id_order_item":null,"fk_oms_order_item_state":null,"variety":null,"created_at":null,"currency_iso_code":null,"is_quantity_splittable":true,"remuneration_amount":null,"shipment":{"id_sales_shipment":null,"requested_delivery_date":"","shipment_selection":1,"merchant_reference":null,"shipping_address":{"first_name":"Spryker","last_name":"Guest","address1":"Seeburger Str.","address2":"270","address3":"Block B","company":"Ottom ltd","city":"Berlin","zip_code":"10115","state":null,"iso2_code":"DE","id_customer_address":null,"uuid":null,"is_default_billing":null,"is_default_shipping":true,"customer_id":null,"fk_customer":null,"email":null,"salutation":"Mr","phone":"","comment":null,"is_deleted":null,"fk_country":null,"fk_region":null,"anonymized_at":null,"is_address_saving_skipped":null,"id_sales_order_address":null,"id_company_unit_address":null,"fk_misc_country":null,"key":null,"region":null,"middle_name":null,"cell_phone":null,"po_box":null,"description":null,"country":null,"method":null},"method":{"id_shipment_method":1,"store_currency_price":490,"name":"Standard","currency_iso_code":"EUR","carrier_name":"Spryker Dummy Shipment","fk_sales_expense":null,"fk_shipment_carrier":1,"fk_tax_set":4,"availability_plugin":null,"price_plugin":null,"delivery_time_plugin":null,"tax_rate":"19.00","is_active":true,"delivery_time":null,"shipment_method_key":"spryker_dummy_shipment-standard","id":null,"source_price":null,"store_relation":{"id_entity":1,"id_stores":[1,2],"stores":[{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]},{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":2,"name":"AT","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}]},"prices":[{"fk_store":1,"net_amount":450,"gross_amount":560,"id_entity":6,"fk_currency":61,"price_data":null,"price_data_checksum":null,"currency":{"code":"CHF","symbol":"CHF","id_currency":61,"name":"Swiss Franc","is_default":null,"fraction_digits":null},"store":{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}},{"fk_store":1,"net_amount":390,"gross_amount":490,"id_entity":1,"fk_currency":93,"price_data":null,"price_data_checksum":null,"currency":{"code":"EUR","symbol":"€","id_currency":93,"name":"Euro","is_default":null,"fraction_digits":null},"store":{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}}]},"carrier":null},"configured_bundle_item":null,"configured_bundle":null,"gift_card_metadata":{"is_gift_card":false,"abstract_configuration":null,"concrete_configuration":null},"price_product":{"sku_product":"${product_sku}","id_price_product":null,"is_active":null,"price_type_name":"DEFAULT","id_product":null,"id_product_abstract":null,"sku_product_abstract":null,"fk_price_type":null,"group_key":"EUR-DEFAULT-1-BOTH-PRICE_DIMENSION_DEFAULT-Default","is_mergeable":true,"concrete_sku":null,"volume_quantity":null,"price_dimension":{"id_merchant_relationship":null,"type":"PRICE_DIMENSION_DEFAULT","name":"Default","id_price_product_default":2149,"product_offer_reference": ${product_offer_reference},"id_product_offer":null,"id_price_product_offer":null},"money_value":{"fk_store":1,"net_amount":770,"gross_amount":880,"id_entity":"2785","fk_currency":93,"price_data":null,"price_data_checksum":null,"currency":{"code":"EUR","symbol":"€","id_currency":93,"name":"Euro","is_default":null,"fraction_digits":null},"store":null},"price_type":{"id_price_type":null,"name":"DEFAULT","price_mode_configuration":"BOTH"}},"state":null,"metadata":null,"product_bundle":null,"product_concrete":null,"quantity_sales_unit":null,"amount_sales_unit":null,"amount_lead_product":null,"product_packaging_unit":null,"sales_order_configured_bundle_item":null,"sales_order_configured_bundle":null,"product_options":[],"calculated_discounts":[],"messages":[],"state_history":[],"images":[],"return_policy_messages":[],"amount":null,"stock":null}],"expenses":{"05527df47d667452fc1c6b9095455cfb":{"id_expense":null,"type":"SHIPMENT_EXPENSE_TYPE","unit_gross_price":490,"sum_gross_price":490,"name":"Standard","tax_rate":"19.00","quantity":1,"unit_net_price":0,"sum_net_price":0,"unit_price":490,"sum_price":490,"refundable_amount":490,"canceled_amount":null,"unit_discount_amount_aggregation":0,"sum_discount_amount_aggregation":0,"unit_price_to_pay_aggregation":490,"sum_price_to_pay_aggregation":490,"tax_amount_after_cancellation":null,"is_ordered":null,"unit_tax_amount":78,"sum_tax_amount":78,"id_sales_expense":null,"merchant_reference":null,"store_currency_price":490,"fk_sales_order":null,"shipment":{"id_sales_shipment":null,"requested_delivery_date":"","shipment_selection":1,"merchant_reference":null,"shipping_address":{"first_name":"Spryker","last_name":"Guest","address1":"Seeburger Str.","address2":"270","address3":"Block B","company":"Ottom ltd","city":"Berlin","zip_code":"10115","state":null,"iso2_code":"DE","id_customer_address":null,"uuid":null,"is_default_billing":null,"is_default_shipping":true,"customer_id":null,"fk_customer":null,"email":null,"salutation":"Mr","phone":"","comment":null,"is_deleted":null,"fk_country":null,"fk_region":null,"anonymized_at":null,"is_address_saving_skipped":null,"id_sales_order_address":null,"id_company_unit_address":null,"fk_misc_country":null,"key":null,"region":null,"middle_name":null,"cell_phone":null,"po_box":null,"description":null,"country":null,"method":null},"method":{"id_shipment_method":1,"store_currency_price":490,"name":"Standard","currency_iso_code":"EUR","carrier_name":"Spryker Dummy Shipment","fk_sales_expense":null,"fk_shipment_carrier":1,"fk_tax_set":4,"availability_plugin":null,"price_plugin":null,"delivery_time_plugin":null,"tax_rate":null,"is_active":true,"delivery_time":null,"shipment_method_key":"spryker_dummy_shipment-standard","id":null,"source_price":null,"store_relation":{"id_entity":1,"id_stores":[1,2],"stores":[{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]},{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":2,"name":"AT","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}]},"prices":[{"fk_store":1,"net_amount":450,"gross_amount":560,"id_entity":6,"fk_currency":61,"price_data":null,"price_data_checksum":null,"currency":{"code":"CHF","symbol":"CHF","id_currency":61,"name":"Swiss Franc","is_default":null,"fraction_digits":null},"store":{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}},{"fk_store":1,"net_amount":390,"gross_amount":490,"id_entity":1,"fk_currency":93,"price_data":null,"price_data_checksum":null,"currency":{"code":"EUR","symbol":"€","id_currency":93,"name":"Euro","is_default":null,"fraction_digits":null},"store":{"available_locale_iso_codes":[],"queue_pools":[],"stores_with_shared_persistence":[],"id_store":1,"name":"DE","default_currency_iso_code":null,"available_currency_iso_codes":[],"selected_currency_iso_code":null,"timezone":null,"countries":[]}}]},"carrier":null},"calculated_discounts":[]}},"voucher_discounts":[],"cart_rule_discounts":[],"promotion_items":[],"gift_cards":[],"payments":[],"bundle_items":[],"incoming_items":[],"quote_approvals":[],"share_details":[]}""")
        .check(status.is(200)
    )

    val scn = scenario(scenarioName)
        .feed(feeder)
        .exec(request)
}

class PlaceOrderWithOffersRamp extends Simulation with PlaceOrderWithOffersBase {

    override lazy val scenarioName = "PlaceOrder page [Incremental]"

    setUp(scn.inject(
        rampUsersPerSec(0) to (Scenario.targetRps.toDouble) during (Scenario.duration),
    ))
        .throttle(reachRps(Scenario.targetRps) in (Scenario.duration))
        .protocols(httpProtocol)
}

class PlaceOrderWithOffersSteady extends Simulation with PlaceOrderWithOffersBase {

    override lazy val scenarioName = "PlaceOrder page [Steady RPS]"

    setUp(scn.inject(
        constantUsersPerSec(Scenario.targetRps.toDouble) during (Scenario.duration),
    ))
        .throttle(
            jumpToRps(Scenario.targetRps),
            holdFor(Scenario.duration),
        )
        .protocols(httpProtocol)
}
